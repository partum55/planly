<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planly</title>
  <link rel="preconnect" href="https://api.fontshare.com">
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700,900&f[]=cabinet-grotesk@700,800&display=swap" rel="stylesheet">
  <style>
    /* ─── Tokens (matches landing page) ────────────────── */
    :root {
      --bg:          #0c0f16;
      --bg-subtle:   #111419;
      --surface:     #171b23;
      --surface-hi:  #1e2330;
      --border:      rgba(240, 237, 230, 0.06);
      --border-hi:   rgba(240, 237, 230, 0.1);

      --accent:      #e8654a;
      --accent-dim:  rgba(232, 101, 74, 0.15);
      --accent-hover:#d4563c;
      --accent-2:    #f4a261;
      --teal:        #4ecdc4;
      --teal-dim:    rgba(78, 205, 196, 0.12);

      --text:        #f0ede6;
      --text-2:      #b0ada4;
      --text-3:      #6b6e7a;

      --success:     #4ecdc4;
      --success-dim: rgba(78, 205, 196, 0.12);
      --error:       #e8654a;
      --error-dim:   rgba(232, 101, 74, 0.12);
      --warning:     #f4a261;
      --warning-dim: rgba(244, 162, 97, 0.12);

      --font-display: 'Cabinet Grotesk', 'Satoshi', sans-serif;
      --font-body:    'Satoshi', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono:    'JetBrains Mono', 'Fira Code', 'SF Mono', monospace;

      --radius:      12px;
      --radius-lg:   20px;
    }

    /* ─── Reset & Base ─────────────────────────────────── */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      background: transparent;
      overflow: hidden;
      user-select: none;
      -webkit-font-smoothing: antialiased;
    }

    /* ─── Grain overlay ────────────────────────────────── */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 9999;
      pointer-events: none;
      opacity: 0.025;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
      background-size: 200px;
    }

    /* ─── Container ────────────────────────────────────── */
    .container {
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      height: 100vh;
      padding: 8px;
    }

    .chat-box {
      position: relative;
      background: var(--bg);
      border: 1px solid var(--border-hi);
      border-radius: var(--radius-lg);
      box-shadow:
        0 24px 80px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.03),
        0 0 80px rgba(232, 101, 74, 0.03);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: calc(100vh - 16px);
      backdrop-filter: blur(24px);
    }

    /* ─── Messages Area ────────────────────────────────── */
    .messages {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 16px 16px 8px;
      scroll-behavior: smooth;
      position: relative;
    }

    .messages.has-messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: rgba(240, 237, 230, 0.1); border-radius: 2px; }

    /* ─── Message Bubbles ──────────────────────────────── */
    .msg-wrapper {
      display: flex;
      flex-direction: column;
      max-width: 85%;
      animation: fadeIn 0.3s ease;
      position: relative;
    }

    .msg-wrapper.user { align-self: flex-end; }
    .msg-wrapper.agent { align-self: flex-start; }

    .msg {
      padding: 10px 14px;
      border-radius: var(--radius);
      font-size: 13.5px;
      line-height: 1.55;
      word-wrap: break-word;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-wrapper.user .msg {
      background: var(--accent);
      color: #fff;
      border-bottom-right-radius: 4px;
      font-weight: 500;
    }

    .msg-wrapper.agent .msg {
      background: var(--surface-hi);
      color: var(--text-2);
      border-bottom-left-radius: 4px;
    }

    /* ─── Copy Button ──────────────────────────────────── */
    .msg-copy-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.4);
      border: none;
      border-radius: 6px;
      color: var(--text-3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s, color 0.15s;
    }

    .msg:hover .msg-copy-btn { opacity: 1; }
    .msg-copy-btn:hover { color: var(--text); }

    .msg-copy-btn.copied { color: var(--teal); }

    /* ─── Message Timestamp ────────────────────────────── */
    .msg-time {
      font-size: 10px;
      color: var(--text-3);
      font-family: var(--font-mono);
      margin-top: 3px;
      opacity: 0.6;
    }

    .msg-wrapper.user .msg-time { text-align: right; }

    /* ─── Markdown in agent messages ───────────────────── */
    .msg strong { font-weight: 700; color: var(--text); }
    .msg em { font-style: italic; }
    .msg code {
      background: rgba(0, 0, 0, 0.3);
      padding: 1px 5px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 12px;
    }
    .msg pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 10px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 6px 0;
    }
    .msg pre code {
      background: none;
      padding: 0;
      font-size: 12px;
    }
    .msg a {
      color: var(--teal);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .msg ul, .msg ol {
      margin: 4px 0 4px 18px;
    }
    .msg li {
      margin-bottom: 2px;
    }

    /* ─── Typing indicator (keep old styles working) ──── */
    .msg .typing-dots {
      display: inline-flex;
      gap: 4px;
    }

    .msg .typing-dots span {
      width: 6px;
      height: 6px;
      background: var(--text-3);
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .msg .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .msg .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
    }

    /* ─── Action Cards ─────────────────────────────────── */
    .action-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
    }

    .action-card {
      background: var(--surface);
      border: 1px solid var(--border-hi);
      border-radius: var(--radius);
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-card:hover {
      border-color: rgba(232, 101, 74, 0.3);
      background: var(--surface-hi);
    }

    .action-card.selected {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .action-card .check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-3);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .action-card.selected .check {
      background: var(--accent);
      border-color: var(--accent);
    }

    .action-card.selected .check::after {
      content: '';
      width: 6px;
      height: 10px;
      border: solid #fff;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      margin-bottom: 2px;
    }

    .action-card .info {
      flex: 1;
    }

    .action-card .tool-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 2px;
      font-family: var(--font-mono);
    }

    .action-card .desc {
      font-size: 13px;
      color: var(--text-2);
    }

    /* ─── Confirm Bar ──────────────────────────────────── */
    .confirm-bar {
      display: none;
      padding: 8px 16px 12px;
      gap: 8px;
      justify-content: flex-end;
    }

    .confirm-bar.visible {
      display: flex;
    }

    .confirm-bar button {
      padding: 8px 18px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: var(--font-body);
    }

    .btn-confirm {
      background: var(--accent);
      color: #fff;
    }
    .btn-confirm:hover { background: var(--accent-hover); }

    .btn-cancel {
      background: var(--surface);
      color: var(--text-3);
      border: 1px solid var(--border-hi);
    }
    .btn-cancel:hover { background: var(--surface-hi); color: var(--text-2); }

    /* ─── Calendar Picker ──────────────────────────────── */
    .picker-container {
      background: var(--surface);
      border: 1px solid var(--border-hi);
      border-radius: var(--radius);
      padding: 14px;
      width: 100%;
    }

    .picker-container label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: var(--teal);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 8px;
      font-family: var(--font-mono);
    }

    .picker-container input {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border-hi);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: var(--font-body);
      outline: none;
      transition: border-color 0.2s;
    }

    .picker-container input:focus {
      border-color: var(--teal);
    }

    .picker-submit {
      margin-top: 8px;
      padding: 6px 14px;
      background: var(--teal);
      color: var(--bg);
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font-body);
      transition: opacity 0.15s;
    }
    .picker-submit:hover { opacity: 0.85; }

    /* ─── Result Items ─────────────────────────────────── */
    .result-item {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 4px;
      font-weight: 500;
    }

    .result-item.success {
      background: var(--success-dim);
      color: var(--success);
    }

    .result-item.failure {
      background: var(--error-dim);
      color: var(--error);
    }

    /* ─── Input Area ───────────────────────────────────── */
    .input-area {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-top: 1px solid var(--border);
    }

    .screenshot-btn {
      width: 34px;
      height: 34px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-3);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .screenshot-btn:hover {
      background: var(--accent-dim);
      border-color: rgba(232, 101, 74, 0.2);
      color: var(--accent);
    }

    .screenshot-btn:disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    /* ─── Screenshot Thumbnail ─────────────────────────── */
    .screenshot-thumb {
      position: relative;
      flex-shrink: 0;
      width: 48px;
      height: 32px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border-hi);
      animation: fadeIn 0.2s ease;
    }

    .screenshot-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .screenshot-thumb .thumb-remove {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 14px;
      height: 14px;
      background: var(--error);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 9px;
      line-height: 14px;
      text-align: center;
      cursor: pointer;
      padding: 0;
    }

    /* ─── OCR Confidence Badge ─────────────────────────── */
    .ocr-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-family: var(--font-mono);
      font-weight: 600;
      animation: fadeIn 0.2s ease;
      transition: opacity 0.3s;
    }

    .ocr-badge.green { background: var(--success-dim); color: var(--success); }
    .ocr-badge.yellow { background: var(--warning-dim); color: var(--warning); }
    .ocr-badge.red { background: var(--error-dim); color: var(--error); }

    .input-area input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 14px;
      font-family: var(--font-body);
      outline: none;
      padding: 8px 0;
    }

    .input-area input::placeholder {
      color: var(--text-3);
    }

    .input-area input:disabled {
      opacity: 0.5;
    }

    .send-btn {
      width: 34px;
      height: 34px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      opacity: 0.3;
      pointer-events: none;
    }

    .send-btn.active {
      opacity: 1;
      pointer-events: auto;
    }

    .send-btn.active:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(232, 101, 74, 0.3);
    }

    .send-btn.processing {
      opacity: 1;
      pointer-events: none;
      animation: pulseRing 1.5s ease-in-out infinite;
    }

    @keyframes pulseRing {
      0%, 100% { box-shadow: 0 0 0 0 rgba(232, 101, 74, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(232, 101, 74, 0); }
    }

    @keyframes spinSmall {
      to { transform: rotate(360deg); }
    }

    .send-btn .spinner-icon {
      animation: spinSmall 0.8s linear infinite;
    }

    /* ─── Retry Button ─────────────────────────────────── */
    .retry-btn {
      display: inline-block;
      padding: 4px 12px;
      margin-top: 6px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font-body);
      transition: background 0.15s;
    }
    .retry-btn:hover { background: var(--accent-hover); }

    /* ─── Scroll-to-bottom pill ────────────────────────── */
    .scroll-bottom-pill {
      display: none;
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      padding: 5px 14px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
      z-index: 50;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      animation: fadeIn 0.2s ease;
    }

    .scroll-bottom-pill.visible { display: block; }

    /* ─── Esc hint ─────────────────────────────────────── */
    .esc-hint {
      text-align: center;
      font-size: 10px;
      color: var(--text-3);
      padding: 0 0 6px;
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
      opacity: 0.5;
    }

    /* ─── Status bar (OCR badge area below input) ──────── */
    .status-bar {
      display: none;
      padding: 0 12px 6px;
      gap: 8px;
      align-items: center;
    }
    .status-bar.visible { display: flex; }

    /* ─── Keyboard Shortcut Overlay ────────────────────── */
    .shortcut-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 500;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.15s ease;
    }

    .shortcut-overlay.visible {
      display: flex;
    }

    .shortcut-card {
      background: var(--surface);
      border: 1px solid var(--border-hi);
      border-radius: var(--radius-lg);
      padding: 24px 28px;
      min-width: 260px;
    }

    .shortcut-card h3 {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
    }

    .shortcut-row .key {
      background: var(--bg);
      border: 1px solid var(--border-hi);
      border-radius: 5px;
      padding: 2px 8px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-2);
    }

    .shortcut-row .action {
      font-size: 12px;
      color: var(--text-3);
    }

    .shortcut-dismiss {
      text-align: center;
      font-size: 10px;
      color: var(--text-3);
      margin-top: 14px;
      font-family: var(--font-mono);
    }

    /* ─── Drag Handle (title bar) ──────────────────────── */
    .drag-handle {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 0 2px;
      cursor: grab;
      user-select: none;
      -webkit-app-region: no-drag;
      flex-shrink: 0;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .drag-handle .grip {
      width: 36px;
      height: 4px;
      background: var(--border-hi);
      border-radius: 2px;
      transition: background 0.15s;
    }

    .drag-handle:hover .grip {
      background: var(--text-3);
    }

    /* ─── Resize Handles ───────────────────────────────── */
    .resize-handle {
      position: absolute;
      z-index: 100;
    }

    .resize-handle.rh-top    { top: -3px; left: 8px; right: 8px; height: 6px; cursor: n-resize; }
    .resize-handle.rh-bottom { bottom: -3px; left: 8px; right: 8px; height: 6px; cursor: s-resize; }
    .resize-handle.rh-left   { top: 8px; bottom: 8px; left: -3px; width: 6px; cursor: w-resize; }
    .resize-handle.rh-right  { top: 8px; bottom: 8px; right: -3px; width: 6px; cursor: e-resize; }

    .resize-handle.rh-top-left     { top: -3px; left: -3px; width: 12px; height: 12px; cursor: nw-resize; }
    .resize-handle.rh-top-right    { top: -3px; right: -3px; width: 12px; height: 12px; cursor: ne-resize; }
    .resize-handle.rh-bottom-left  { bottom: -3px; left: -3px; width: 12px; height: 12px; cursor: sw-resize; }
    .resize-handle.rh-bottom-right { bottom: -3px; right: -3px; width: 12px; height: 12px; cursor: se-resize; }
  </style>
</head>
<body>

<div class="container">
  <div class="chat-box" id="chatBox">
    <!-- Resize handles (edges + corners) -->
    <div class="resize-handle rh-top" data-direction="n"></div>
    <div class="resize-handle rh-bottom" data-direction="s"></div>
    <div class="resize-handle rh-left" data-direction="w"></div>
    <div class="resize-handle rh-right" data-direction="e"></div>
    <div class="resize-handle rh-top-left" data-direction="nw"></div>
    <div class="resize-handle rh-top-right" data-direction="ne"></div>
    <div class="resize-handle rh-bottom-left" data-direction="sw"></div>
    <div class="resize-handle rh-bottom-right" data-direction="se"></div>

    <!-- Drag handle (title bar) -->
    <div class="drag-handle" id="dragHandle" title="Drag to move window" tabindex="0" role="slider" aria-label="Drag to move window">
      <div class="grip"></div>
    </div>

    <div class="messages" id="messages">
      <button class="scroll-bottom-pill" id="scrollPill">&#8595; New messages</button>
    </div>
    <div class="confirm-bar" id="confirmBar">
      <button class="btn-cancel" id="btnCancelActions">Cancel</button>
      <button class="btn-confirm" id="btnConfirmActions">Confirm</button>
    </div>
    <div class="input-area" id="inputArea">
      <button class="screenshot-btn" id="btnScreenshot" title="Take screenshot">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <rect x="1" y="3" width="14" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="8" cy="8" r="2.5" stroke="currentColor" stroke-width="1.5"/>
        </svg>
      </button>
      <input type="text" id="inputField" placeholder="Type a command... e.g. 'appoint dinner'" autofocus />
      <button class="send-btn" id="btnSend">
        <svg class="send-arrow" width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M1 7h10M8 4l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div class="status-bar" id="statusBar"></div>
    <div class="esc-hint">esc to close &middot; ? for shortcuts</div>
  </div>
</div>

<!-- Keyboard shortcut overlay -->
<div class="shortcut-overlay" id="shortcutOverlay">
  <div class="shortcut-card">
    <h3>Keyboard Shortcuts</h3>
    <div class="shortcut-row"><span class="action">Send message</span><span class="key">Enter</span></div>
    <div class="shortcut-row"><span class="action">Close window</span><span class="key">Esc</span></div>
    <div class="shortcut-row"><span class="action">Show shortcuts</span><span class="key">?</span></div>
    <div class="shortcut-row"><span class="action">Take screenshot</span><span class="action">Camera button</span></div>
    <div class="shortcut-row"><span class="action">Open Planly</span><span class="key">Ctrl+Alt+J</span></div>
    <div class="shortcut-dismiss">Press any key to dismiss</div>
  </div>
</div>

<script>
  // ─── State ──────────────────────────────────────────────
  let conversationId = null;
  let selectedActionIds = new Set();
  let currentActions = [];
  let lastScreenshot = null;
  let isProcessing = false;
  let currentAbortController = null;
  let lastPromptText = '';
  let userIsScrolledUp = false;

  // SVG constants
  const SEND_ARROW_SVG = '<svg class="send-arrow" width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M1 7h10M8 4l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  const SPINNER_SVG = '<svg class="spinner-icon" width="14" height="14" viewBox="0 0 14 14" fill="none"><circle cx="7" cy="7" r="5.5" stroke="currentColor" stroke-width="1.5" stroke-dasharray="24" stroke-dashoffset="8" stroke-linecap="round"/></svg>';

  // ─── DOM refs ───────────────────────────────────────────
  const messagesEl = document.getElementById('messages');
  const inputField = document.getElementById('inputField');
  const btnSend = document.getElementById('btnSend');
  const btnScreenshot = document.getElementById('btnScreenshot');
  const confirmBar = document.getElementById('confirmBar');
  const btnConfirmActions = document.getElementById('btnConfirmActions');
  const btnCancelActions = document.getElementById('btnCancelActions');
  const statusBar = document.getElementById('statusBar');
  const scrollPill = document.getElementById('scrollPill');
  const shortcutOverlay = document.getElementById('shortcutOverlay');

  // ─── Planly bridge (from preload) ──────────────────────
  const planlyApi = window.planly;

  // ─── Processing UI helpers ────────────────────────────
  function setProcessingUI(active) {
    if (active) {
      btnSend.innerHTML = SPINNER_SVG;
      btnSend.classList.remove('active');
      btnSend.classList.add('processing');
      inputField.disabled = true;
      inputField.placeholder = 'Thinking...';
      btnScreenshot.disabled = true;
    } else {
      btnSend.innerHTML = SEND_ARROW_SVG;
      btnSend.classList.remove('processing');
      inputField.disabled = false;
      inputField.placeholder = "Type a command... e.g. 'appoint dinner'";
      btnScreenshot.disabled = false;
      btnSend.classList.toggle('active', inputField.value.trim().length > 0);
    }
  }

  // ─── Screenshot thumbnail ─────────────────────────────
  function showScreenshotThumbnail() {
    removeScreenshotThumbnail();
    if (!lastScreenshot || !lastScreenshot.imageBase64) return;

    const thumb = document.createElement('div');
    thumb.className = 'screenshot-thumb';
    thumb.id = 'screenshotThumb';

    const img = document.createElement('img');
    img.src = 'data:image/png;base64,' + lastScreenshot.imageBase64;
    thumb.appendChild(img);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'thumb-remove';
    removeBtn.textContent = '\u00d7';
    removeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      lastScreenshot = null;
      removeScreenshotThumbnail();
    });
    thumb.appendChild(removeBtn);

    const inputArea = document.getElementById('inputArea');
    inputArea.insertBefore(thumb, inputField);
  }

  function removeScreenshotThumbnail() {
    const existing = document.getElementById('screenshotThumb');
    if (existing) existing.remove();
  }

  // ─── OCR confidence badge ──────────────────────────────
  function showOcrBadge(confidence) {
    statusBar.innerHTML = '';
    const pct = Math.round(confidence * 100);
    let colorClass = 'green';
    if (pct < 50) colorClass = 'red';
    else if (pct < 80) colorClass = 'yellow';

    const badge = document.createElement('span');
    badge.className = 'ocr-badge ' + colorClass;
    badge.textContent = 'OCR: ' + pct + '%';
    statusBar.appendChild(badge);
    statusBar.classList.add('visible');

    setTimeout(() => {
      badge.style.opacity = '0';
      setTimeout(() => {
        statusBar.classList.remove('visible');
        statusBar.innerHTML = '';
      }, 300);
    }, 3000);
  }

  // ─── Input handling ────────────────────────────────────
  inputField.addEventListener('input', () => {
    btnSend.classList.toggle('active', inputField.value.trim().length > 0 && !isProcessing);
  });

  inputField.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && inputField.value.trim()) {
      handleSend();
    }
    // ? shortcut — only when input is empty
    if (e.key === '?' && inputField.value === '') {
      e.preventDefault();
      shortcutOverlay.classList.add('visible');
    }
  });

  // Global Esc to close
  document.addEventListener('keydown', (e) => {
    // Dismiss shortcut overlay first
    if (shortcutOverlay.classList.contains('visible')) {
      shortcutOverlay.classList.remove('visible');
      e.preventDefault();
      return;
    }
    if (e.key === 'Escape') {
      if (window.planly) {
        window.planly.closeChat();
      }
    }
  });

  // Dismiss shortcut overlay on click
  shortcutOverlay.addEventListener('click', () => {
    shortcutOverlay.classList.remove('visible');
  });

  btnSend.addEventListener('click', () => {
    if (inputField.value.trim()) handleSend();
  });

  // ─── Screenshot button ─────────────────────────────────
  btnScreenshot.addEventListener('click', async () => {
    btnScreenshot.style.color = 'var(--accent)';
    try {
      lastScreenshot = await planlyApi.takeScreenshot();
      btnScreenshot.style.color = 'var(--teal)';
      showScreenshotThumbnail();
      setTimeout(() => { btnScreenshot.style.color = ''; }, 1500);
    } catch (err) {
      btnScreenshot.style.color = 'var(--error)';
      setTimeout(() => { btnScreenshot.style.color = ''; }, 1500);
      reportError('screenshot', err);
    }
  });

  // ─── Confirm / Cancel actions ──────────────────────────
  btnConfirmActions.addEventListener('click', () => handleConfirmActions());
  btnCancelActions.addEventListener('click', () => {
    selectedActionIds.clear();
    confirmBar.classList.remove('visible');
    document.querySelectorAll('.action-card').forEach(c => c.classList.remove('selected'));
  });

  // ─── Scroll detection for "scroll to bottom" pill ──────
  messagesEl.addEventListener('scroll', () => {
    const threshold = 60;
    const atBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < threshold;
    userIsScrolledUp = !atBottom;
    if (atBottom) {
      scrollPill.classList.remove('visible');
    }
  });

  scrollPill.addEventListener('click', () => {
    scrollToBottom();
    scrollPill.classList.remove('visible');
  });

  // ─── Reset on toggle (issues 3a, 3b) ───────────────────
  planlyApi.resetChat(() => {
    if (currentAbortController) {
      currentAbortController.abort();
      currentAbortController = null;
    }
    conversationId = null;
    selectedActionIds.clear();
    currentActions = [];
    lastScreenshot = null;
    isProcessing = false;
    lastPromptText = '';
    messagesEl.querySelectorAll('.msg-wrapper, .action-cards, .picker-container, .result-item, .typing-indicator').forEach(el => el.remove());
    messagesEl.classList.remove('has-messages');
    confirmBar.classList.remove('visible');
    scrollPill.classList.remove('visible');
    statusBar.classList.remove('visible');
    statusBar.innerHTML = '';
    removeScreenshotThumbnail();
    setProcessingUI(false);
    inputField.value = '';
    btnSend.classList.remove('active');
    requestResize();
  });

  // ─── Core: Send message ─────────────────────────────────
  async function handleSend() {
    if (isProcessing) return;
    const text = inputField.value.trim();
    if (!text) return;

    isProcessing = true;
    lastPromptText = text;
    inputField.value = '';
    btnSend.classList.remove('active');
    setProcessingUI(true);

    addMessage('user', text);

    // If no screenshot taken yet, take one automatically
    if (!lastScreenshot) {
      addTypingIndicator();
      try {
        lastScreenshot = await planlyApi.takeScreenshot();
      } catch (err) {
        removeAllTypingIndicators();
        addMessage('agent', 'Failed to capture screenshot. Please try the camera button manually.');
        reportError('auto-screenshot', err);
        isProcessing = false;
        setProcessingUI(false);
        return;
      }
    }

    removeScreenshotThumbnail();

    if (!document.querySelector('.typing-indicator')) {
      addTypingIndicator();
    }

    // Set up timeout
    const abortController = { aborted: false };
    currentAbortController = abortController;
    const timeoutId = setTimeout(() => {
      if (!abortController.aborted) {
        abortController.aborted = true;
        removeAllTypingIndicators();
        addTimeoutMessage();
        isProcessing = false;
        setProcessingUI(false);
        currentAbortController = null;
      }
    }, 30000);

    try {
      const ocrResult = await planlyApi.runOCR(lastScreenshot.imageBase64);

      if (abortController.aborted) return;

      // Show OCR confidence badge
      if (ocrResult && typeof ocrResult.confidence === 'number') {
        showOcrBadge(ocrResult.confidence);
      }

      const response = await planlyApi.agentProcess({
        conversation_id: conversationId,
        user_prompt: text,
        messages: ocrResult.messages,
        screenshot_metadata: {
          ocr_confidence: ocrResult.confidence,
          raw_text: ocrResult.rawText,
        },
      });

      clearTimeout(timeoutId);
      if (abortController.aborted) return;
      currentAbortController = null;

      removeAllTypingIndicators();

      if (!response || !response.conversation_id) {
        addMessage('agent', 'Received an unexpected response from the server.');
        reportError('agent:process', 'Missing conversation_id in response');
        return;
      }

      if (!response.blocks || !Array.isArray(response.blocks)) {
        addMessage('agent', 'Received an unexpected response format.');
        reportError('agent:process', 'Missing or invalid blocks array');
        conversationId = response.conversation_id;
        return;
      }

      conversationId = response.conversation_id;
      lastScreenshot = null;
      renderBlocks(response.blocks);

    } catch (err) {
      clearTimeout(timeoutId);
      if (abortController.aborted) return;
      currentAbortController = null;

      removeAllTypingIndicators();
      const errMsg = err && err.message ? err.message : 'Unknown error';

      if (errMsg.includes('401') || errMsg.toLowerCase().includes('unauthorized')) {
        addMessage('agent', 'Your session has expired. Please log in again.');
      } else {
        addMessage('agent', 'Something went wrong: ' + errMsg);
      }
      reportError('handleSend', errMsg);
    } finally {
      isProcessing = false;
      setProcessingUI(false);
    }
  }

  // ─── Timeout with retry button ─────────────────────────
  function addTimeoutMessage() {
    const wrapper = document.createElement('div');
    wrapper.className = 'msg-wrapper agent';

    const msg = document.createElement('div');
    msg.className = 'msg';
    msg.textContent = 'Request timed out. ';

    const retryBtn = document.createElement('button');
    retryBtn.className = 'retry-btn';
    retryBtn.textContent = 'Retry';
    retryBtn.addEventListener('click', () => {
      wrapper.remove();
      inputField.value = lastPromptText;
      handleSend();
    });
    msg.appendChild(retryBtn);

    const time = document.createElement('div');
    time.className = 'msg-time';
    time.dataset.ts = Date.now();
    time.textContent = 'just now';

    wrapper.appendChild(msg);
    wrapper.appendChild(time);
    messagesEl.appendChild(wrapper);
    messagesEl.classList.add('has-messages');
    scrollToBottom();
    requestResize();
  }

  // ─── Confirm actions ────────────────────────────────────
  async function handleConfirmActions() {
    if (selectedActionIds.size === 0) return;

    confirmBar.classList.remove('visible');
    addTypingIndicator();

    try {
      const response = await planlyApi.agentConfirm(
        conversationId,
        Array.from(selectedActionIds)
      );

      removeAllTypingIndicators();

      if (!response || !Array.isArray(response.results)) {
        addMessage('agent', 'Received an unexpected confirmation response.');
        reportError('agent:confirm', 'Invalid response shape');
        return;
      }

      for (const result of response.results) {
        const el = document.createElement('div');
        el.className = 'result-item ' + (result.success ? 'success' : 'failure');
        el.textContent = (result.success ? '\u2713 ' : '\u2717 ') + (result.tool || '') + ': ' +
          (result.success ? 'Done' : 'Failed');
        messagesEl.appendChild(el);
      }

      if (response.formatted_response) {
        addMessage('agent', response.formatted_response);
      }

      selectedActionIds.clear();
      currentActions = [];
      scrollToBottom();
      requestResize();
    } catch (err) {
      removeAllTypingIndicators();
      const errMsg = err && err.message ? err.message : 'Unknown error';
      addMessage('agent', 'Failed to execute actions: ' + errMsg);
      reportError('handleConfirmActions', errMsg);
    }
  }

  // ─── Render response blocks ─────────────────────────────
  function renderBlocks(blocks) {
    for (const block of blocks) {
      switch (block.type) {
        case 'text':
          if (block.content) addMessage('agent', block.content);
          break;

        case 'action_cards':
          if (Array.isArray(block.actions) && block.actions.length > 0) {
            renderActionCards(block.actions);
          }
          break;

        case 'calendar_picker':
          renderPicker('date', block.prompt || 'Pick a date');
          break;

        case 'time_picker':
          renderPicker('time', block.prompt || 'Pick a time');
          break;

        case 'error':
          addMessage('agent', block.message || 'An error occurred.');
          break;

        default:
          reportError('renderBlocks', 'Unknown block type: ' + block.type);
          break;
      }
    }

    scrollToBottom();
    requestResize();
  }

  function renderActionCards(actions) {
    currentActions = actions;
    selectedActionIds.clear();

    const wrapper = document.createElement('div');
    wrapper.className = 'action-cards';

    for (const action of actions) {
      if (!action || !action.action_id) continue;

      const card = document.createElement('div');
      card.className = 'action-card';
      card.dataset.actionId = action.action_id;
      card.innerHTML = `
        <div class="check"></div>
        <div class="info">
          <div class="tool-name">${escapeHtml(action.tool || 'unknown')}</div>
          <div class="desc">${escapeHtml(action.description || '')}</div>
        </div>
      `;

      card.addEventListener('click', () => {
        card.classList.toggle('selected');
        if (card.classList.contains('selected')) {
          selectedActionIds.add(action.action_id);
        } else {
          selectedActionIds.delete(action.action_id);
        }
        confirmBar.classList.toggle('visible', selectedActionIds.size > 0);
      });

      wrapper.appendChild(card);
    }

    messagesEl.appendChild(wrapper);
    messagesEl.classList.add('has-messages');
    scrollToBottom();
    requestResize();
  }

  function renderPicker(type, prompt) {
    const container = document.createElement('div');
    container.className = 'picker-container';

    const inputType = type === 'date' ? 'date' : 'time';
    container.innerHTML = `
      <label>${escapeHtml(prompt)}</label>
      <input type="${inputType}" class="picker-input" />
      <button class="picker-submit">Set</button>
    `;

    const submitBtn = container.querySelector('.picker-submit');
    const pickerInput = container.querySelector('.picker-input');

    submitBtn.addEventListener('click', () => {
      const val = pickerInput.value;
      if (!val) return;
      container.remove();
      inputField.value = val;
      handleSend();
    });

    messagesEl.appendChild(container);
    messagesEl.classList.add('has-messages');
    scrollToBottom();
    requestResize();
  }

  // ─── Markdown parser (lightweight, regex-based) ────────
  function renderMarkdown(text) {
    let html = escapeHtml(text);

    // Code blocks (```)
    html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
      return '<pre><code>' + code.trim() + '</code></pre>';
    });

    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Bold
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // Italic
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

    // Links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

    // Bullet lists (lines starting with - or *)
    html = html.replace(/((?:^|\n)(?:[*\-] .+(?:\n|$))+)/g, (match) => {
      const items = match.trim().split('\n').map(line => {
        const content = line.replace(/^[*\-] /, '');
        return '<li>' + content + '</li>';
      }).join('');
      return '<ul>' + items + '</ul>';
    });

    // Line breaks
    html = html.replace(/\n/g, '<br>');

    return html;
  }

  // ─── Helpers ────────────────────────────────────────────
  function addMessage(role, text) {
    const wrapper = document.createElement('div');
    wrapper.className = 'msg-wrapper ' + role;

    const msg = document.createElement('div');
    msg.className = 'msg';

    if (role === 'agent') {
      msg.innerHTML = renderMarkdown(text);
    } else {
      msg.textContent = text;
    }

    // Copy button
    const copyBtn = document.createElement('button');
    copyBtn.className = 'msg-copy-btn';
    copyBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="4" y="4" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.2"/><path d="M8 4V2.5A1.5 1.5 0 006.5 1H2.5A1.5 1.5 0 001 2.5v4A1.5 1.5 0 002.5 8H4" stroke="currentColor" stroke-width="1.2"/></svg>';
    copyBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.classList.add('copied');
        copyBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6l3 3 5-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        setTimeout(() => {
          copyBtn.classList.remove('copied');
          copyBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><rect x="4" y="4" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="1.2"/><path d="M8 4V2.5A1.5 1.5 0 006.5 1H2.5A1.5 1.5 0 001 2.5v4A1.5 1.5 0 002.5 8H4" stroke="currentColor" stroke-width="1.2"/></svg>';
        }, 1500);
      });
    });
    msg.appendChild(copyBtn);

    // Timestamp
    const time = document.createElement('div');
    time.className = 'msg-time';
    time.dataset.ts = Date.now();
    time.textContent = 'just now';

    wrapper.appendChild(msg);
    wrapper.appendChild(time);
    messagesEl.appendChild(wrapper);
    messagesEl.classList.add('has-messages');

    if (userIsScrolledUp) {
      scrollPill.classList.add('visible');
    } else {
      scrollToBottom();
    }
    requestResize();
  }

  function addTypingIndicator() {
    removeAllTypingIndicators();
    const el = document.createElement('div');
    el.className = 'msg-wrapper agent typing-indicator';
    el.innerHTML = '<div class="msg"><div class="typing-dots"><span></span><span></span><span></span></div></div>';
    messagesEl.appendChild(el);
    messagesEl.classList.add('has-messages');
    scrollToBottom();
    requestResize();
  }

  function removeAllTypingIndicators() {
    document.querySelectorAll('.typing-indicator').forEach(el => el.remove());
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function requestResize() {
    requestAnimationFrame(() => {
      const chatBox = document.querySelector('.chat-box');
      const contentHeight = chatBox.scrollHeight + 16;
      const minHeight = 72;
      const needed = Math.max(minHeight, contentHeight);
      planlyApi.resizeChat(needed);
    });
  }

  function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ─── Relative timestamp updater ────────────────────────
  function relativeTime(ts) {
    const diff = Math.floor((Date.now() - ts) / 1000);
    if (diff < 10) return 'just now';
    if (diff < 60) return diff + 's ago';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  }

  setInterval(() => {
    document.querySelectorAll('.msg-time[data-ts]').forEach(el => {
      el.textContent = relativeTime(parseInt(el.dataset.ts, 10));
    });
  }, 30000);

  // ─── Error reporting (issue 5a) ─────────────────────────
  function reportError(context, err) {
    const msg = (err && typeof err === 'object' && err.message) ? err.message : String(err);
    console.error('[' + context + ']', msg);
    try { planlyApi.reportError(context, msg); } catch (_) {}
  }

  // ─── Initial focus ──────────────────────────────────────
  inputField.focus();
  requestResize();
  // ═══════════════════════════════════════════════════════
  // WindowManager — handles drag & resize event flows
  // ═══════════════════════════════════════════════════════

  const WindowManager = (() => {
    const KEYBOARD_MOVE_STEP = 20; // px per arrow key press

    // ─── Drag state ──────────────────────────
    let isDragging = false;
    let dragStartScreenX = 0;
    let dragStartScreenY = 0;

    // ─── Resize state ────────────────────────
    let isResizing = false;
    let resizeDir = '';
    let resizeStartScreenX = 0;
    let resizeStartScreenY = 0;
    let resizeStartBounds = { x: 0, y: 0, width: 0, height: 0 };
    let constraints = { minWidth: 360, maxWidth: 960, minHeight: 72, maxHeight: 1200 };

    // Load constraints from main process
    async function loadConstraints() {
      try {
        constraints = await planlyApi.getWindowConstraints();
      } catch (_) {}
    }
    loadConstraints();

    // ─── Drag logic ──────────────────────────

    const dragHandle = document.getElementById('dragHandle');

    function onDragStart(e) {
      if (e.button !== 0) return;
      if (e.target !== dragHandle && !dragHandle.contains(e.target)) return;

      isDragging = true;
      dragStartScreenX = e.screenX;
      dragStartScreenY = e.screenY;

      dragHandle.setPointerCapture(e.pointerId);
      dragHandle.style.cursor = 'grabbing';
      document.body.style.userSelect = 'none';

      e.preventDefault();
    }

    function onDragMove(e) {
      if (!isDragging) return;

      const dx = e.screenX - dragStartScreenX;
      const dy = e.screenY - dragStartScreenY;

      if (dx !== 0 || dy !== 0) {
        planlyApi.moveWindow(dx, dy);
        dragStartScreenX = e.screenX;
        dragStartScreenY = e.screenY;
      }
    }

    function onDragEnd(e) {
      if (!isDragging) return;
      isDragging = false;

      try { dragHandle.releasePointerCapture(e.pointerId); } catch (_) {}
      dragHandle.style.cursor = '';
      document.body.style.userSelect = '';

      planlyApi.saveWindowBounds();
    }

    dragHandle.addEventListener('pointerdown', onDragStart);
    dragHandle.addEventListener('pointermove', onDragMove);
    dragHandle.addEventListener('pointerup', onDragEnd);
    dragHandle.addEventListener('pointercancel', onDragEnd);

    // ─── Keyboard accessibility for drag handle ──

    dragHandle.addEventListener('keydown', (e) => {
      let dx = 0, dy = 0;
      switch (e.key) {
        case 'ArrowLeft':  dx = -KEYBOARD_MOVE_STEP; break;
        case 'ArrowRight': dx = KEYBOARD_MOVE_STEP; break;
        case 'ArrowUp':    dy = -KEYBOARD_MOVE_STEP; break;
        case 'ArrowDown':  dy = KEYBOARD_MOVE_STEP; break;
        default: return;
      }
      e.preventDefault();
      planlyApi.moveWindow(dx, dy);
      planlyApi.saveWindowBounds();
    });

    // ─── Resize logic ────────────────────────

    const resizeHandles = document.querySelectorAll('.resize-handle');

    async function onResizeStart(e) {
      if (e.button !== 0) return;

      const dir = e.currentTarget.dataset.direction;
      if (!dir) return;

      isResizing = true;
      resizeDir = dir;
      resizeStartScreenX = e.screenX;
      resizeStartScreenY = e.screenY;

      try {
        const bounds = await planlyApi.getWindowBounds();
        if (bounds) resizeStartBounds = { ...bounds };
      } catch (_) {}

      e.currentTarget.setPointerCapture(e.pointerId);
      document.body.style.userSelect = 'none';
      e.preventDefault();
    }

    function onResizeMove(e) {
      if (!isResizing) return;

      const dx = e.screenX - resizeStartScreenX;
      const dy = e.screenY - resizeStartScreenY;

      let { x, y, width, height } = resizeStartBounds;

      if (resizeDir.includes('e')) {
        width = resizeStartBounds.width + dx;
      }
      if (resizeDir.includes('w')) {
        width = resizeStartBounds.width - dx;
        x = resizeStartBounds.x + dx;
      }
      if (resizeDir.includes('s')) {
        height = resizeStartBounds.height + dy;
      }
      if (resizeDir.includes('n')) {
        height = resizeStartBounds.height - dy;
        y = resizeStartBounds.y + dy;
      }

      width = Math.max(constraints.minWidth, Math.min(width, constraints.maxWidth));
      height = Math.max(constraints.minHeight, Math.min(height, constraints.maxHeight));

      if (resizeDir.includes('w')) {
        x = resizeStartBounds.x + resizeStartBounds.width - width;
      }
      if (resizeDir.includes('n')) {
        y = resizeStartBounds.y + resizeStartBounds.height - height;
      }

      planlyApi.setWindowBounds({ x: Math.round(x), y: Math.round(y), width: Math.round(width), height: Math.round(height) });
    }

    function onResizeEnd(e) {
      if (!isResizing) return;
      isResizing = false;
      resizeDir = '';

      try { e.currentTarget.releasePointerCapture(e.pointerId); } catch (_) {}
      document.body.style.userSelect = '';

      planlyApi.saveWindowBounds();
    }

    resizeHandles.forEach((handle) => {
      handle.addEventListener('pointerdown', onResizeStart);
      handle.addEventListener('pointermove', onResizeMove);
      handle.addEventListener('pointerup', onResizeEnd);
      handle.addEventListener('pointercancel', onResizeEnd);
    });

    return { loadConstraints };
  })();</script>

</body>
</html>
